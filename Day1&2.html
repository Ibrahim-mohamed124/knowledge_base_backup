<!--
title: Chapter 1.  Authentication and Identity Management
description: 
published: true
date: 2025-11-05T12:29:25.861Z
tags: 
editor: ckeditor
dateCreated: 2025-11-05T10:36:26.618Z
-->

<h1>Chapter&nbsp;1.&nbsp; Authentication and Identity Management</h1>
<ul>
  <li>Authentication could be via <mark class="marker-yellow">certificates or tokens</mark></li>
  <li>Kubernetes considers to be authenticated any user that presents<mark class="marker-yellow"> a valid certificate that is signed by a trusted certificate authority (CA).</mark> Kubernetes reads the <code>subject</code> field from the certificate, and assigns the username and the groups with the <code>common name</code> (CN) and the <code>organization</code> (O) fields, respectively.</li>
  <li>If the request does not present an access token or certificate, then Kubernetes assigns to the request the <code>system:anonymous</code> system user and the <code>system:unauthenticated</code> system group.</li>
  <li>Kubernetes uses RBAC policies to determine whether the anonymous user has appropriate access to perform the requested action.</li>
</ul>
<h2>Authentication in OpenShift</h2>
<ul>
  <li>OpenShift includes its own built-in OAuth server</li>
</ul>
<h3>Authentication Methods</h3>
<ul>
  <li>The OpenShift OAuth server handles user authentication, and it issues OAuth tokens that grant access to specific resources.</li>
</ul>
<ol>
  <li><strong>X.509 client certificates</strong></li>
  <li><strong>OAuth access tokens</strong>
    <ul>
      <li>OpenShift preconfigures Kubernetes to trust tokens that its own internal OAuth server issues.&nbsp;</li>
    </ul>
  </li>
</ol>
<h3>The OpenShift OAuth Server</h3>
<ul>
  <li>At OCP instillation the authentication operator is installed, which managed the lifecycle of the OAuth server</li>
  <li>The <mark class="marker-yellow">OpenShift OAuth server provides various identity providers (IdPs) that enable integration with identity management systems</mark> such as OpenID Connect and LDAP servers.</li>
</ul>
<figure class="image image_resized" style="width:100%;"><img src="/auth-firstlogin.svg"></figure>
<ul>
  <li>OpenShift web console stores the token in the browser memory instead of in a <code>kubeconfig</code> file</li>
  <li>The<mark class="marker-yellow"> two endpoints for login, which are the API server and the OAuth server,</mark> are the reason why you must accept two server certificates the first time that you log in to the OpenShift web console.</li>
  <li>OAuth user access tokens can be retrieved &nbsp;from the OpenShift OAuth server by using the <code><i>namespace_route</i>/oauth/authorize</code> and <code><i>namespace_route</i>/oauth/token</code> endpoints.</li>
</ul>
<h4>Configure the OpenShift OAuth Server</h4>
<ul>
  <li>After the user successfully logs in to the cluster, the OAuth server creates the<mark class="marker-yellow"> OAuth access token for the user</mark>, and <mark class="marker-yellow">OpenShift creates the identity and user resources.</mark></li>
</ul>
<pre><code class="language-plaintext">apiVersion: config.openshift.io/v1
kind: OAuth
metadata:
  name: cluster
spec:
  identityProviders: 1
  - name: htpasswd-idp-name 2
    mappingMethod: claim 3
    type: HTPasswd
    htpasswd:
      fileData:
        name: htpasswd-secret 4
  - name: ldap-idp-name
    mappingMethod: claim
    type: LDAP
    ldap:
...output omitted...</code></pre>
<h3>Users, Groups, and Identities</h3>
<h4>System Groups</h4>
<ul>
  <li>predefined groups that are<mark class="marker-yellow"> built into the system</mark> to grant specific permissions and access rights to certain categories of users.<ul>
      <li><code><strong>system:authenticated</strong></code>
        <ul>
          <li>All authenticated users in the cluster, regardless of their role or namespace</li>
        </ul>
      </li>
      <li><code><strong>system:authenticated:oauth</strong></code>
        <ul>
          <li>All authenticated users with an OAuth access token in the cluster</li>
        </ul>
      </li>
      <li><code><strong>system:unauthenticated</strong></code>
        <ul>
          <li>Unauthenticated users, meaning those users who did not yet pass any authentication process</li>
        </ul>
      </li>
      <li><code><strong>system:masters</strong></code>
        <ul>
          <li>Users with administrative access to the cluster Members of this group have full control over all resources and actions within the cluster, including cluster-level operations and management.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>The<mark class="marker-yellow"> Kubernetes API server adds the strings from system groups to the user and group strings from the client certificate or from the token</mark>, whenever they apply. Then, Kubernetes uses RBAC rules to approve or deny the request depending on the user and groups.</li>
</ul>
<h4>User resource</h4>
<ul>
  <li>Defines regular users in the cluster</li>
</ul>
<pre><code class="language-plaintext">apiVersion: user.openshift.io/v1
kind: User
metadata:
  name: ibrahim
fullName: Ibrahim El Giza
identities:
  - myidp:ibrahim
groups:
  - dev-team
  - openshift-admins
</code></pre>
<ul>
  <li>The OpenShift internal OAuth server automatically creates user resources when users first log in to the cluster through an IdP.&nbsp;</li>
</ul>
<h4>Group resources&nbsp;</h4>
<ul>
  <li>Defines groups in the cluster.</li>
  <li>OpenShift supports users as members of one or more groups.</li>
  <li>OpenShift internal OAuth server automatically creates group resources when users first log in to the cluster through an OpenID Connect (OIDC) IdP.&nbsp;</li>
  <li>Other supported IdPs should &nbsp;manually manage group resources in OpenShift.</li>
</ul>
<pre><code class="language-plaintext">apiVersion: user.openshift.io/v1
kind: Group
metadata:
  name: dev-team
users:
  - ibrahim
  - fatma
  - ahmed
</code></pre>
<h4>Identity resource</h4>
<ul>
  <li>The identity resource keeps a record of successful authentication attempts from a specific <mark class="marker-yellow">user and IdP.</mark></li>
  <li>OpenShift maps external user identities from IdPs to user resources.</li>
</ul>
<pre><code class="language-plaintext">apiVersion: user.openshift.io/v1
kind: Identity
metadata:
  name: myidp:ibrahim
providerName: myidp
providerUserName: ibrahim
user:
  name: ibrahim
  uid: 12345678-90ab-cdef-1234-567890abcdef
</code></pre>
<h3>OAuth Server Mapping Methods</h3>
<ul>
  <li>After a login, openshift creates the user(from the preferred name in the idp) and identity resources and maps them.</li>
  <li>To avoid collisions, mappingMethod parameter is essential:<ul>
      <li>claim:<mark class="marker-yellow"> fails if a user with that username is already mapped to another identity</mark></li>
      <li>add: If a user with that username exists in OpenShift, then it maps the identity to the existing user, <mark class="marker-yellow">and adds the new identity to any existing identity mappings for the user.</mark></li>
      <li>lookup: OpenShift looks up an existing identity, user identity mapping, and user,<mark class="marker-yellow"> but does not automatically provision users or identities.</mark> Thus, with this method you must manually provision users. With this method, cluster administrators can set up identities and users manually, or by using an external process.</li>
    </ul>
  </li>
</ul>
<h2>LDAP Authentication and Group Synchronization</h2>
<ul>
  <li>When users enter credentials for the cluster, the OAuth server initiates a connection and a corresponding <mark class="marker-yellow">query to the LDAP server,</mark> and creates bindings when matching unique entries are found.</li>
  <li><mark class="marker-yellow">Additional configuration within the OpenShift cluster is required to synchronize groups from the LDAP database</mark>, as well as to define the appropriate access and permissions for each group.</li>
</ul>
<blockquote>
  <p>The LDAP protocol defines a query language to retrieve information from database entries of a remote LDAP server, which can contain entries for users and groups within the organization.</p>
</blockquote>
<ul>
  <li>LDAP:<ul>
      <li>LDAP URI: a string that contains a group of parameters that are essential to the query:<ul>
          <li>ldap: The LDAP protocol designation. For LDAP over SSL, use the <code>ldaps</code> protocol. Red&nbsp;Hat recommends using StartTLS over regular <code>ldap</code>.</li>
          <li>host:port: the hostname and the listening port of the LDAP server, The default for <code>ldap</code> is <code>localhost:389</code>, and for <code>ldaps</code> is <code>localhost:636</code>.</li>
          <li>basedn: The DN of the directory where a query begins. This directory is used as the root location for the search.</li>
          <li>attributes<mark class="marker-yellow">: The target for the search, with the default as </mark><code><mark class="marker-yellow">uid</mark></code><mark class="marker-yellow">,</mark> which<mark class="marker-yellow"> the LDAP lookup is intended to return</mark>. Multiple attributes are provided by a comma-separated list.</li>
          <li>scope: The scope of the LDAP lookup. The scope is either <code>one</code> or <code>sub</code>. The default is <code>sub</code> if unspecified.</li>
          <li>filter: An LDAP filte<mark class="marker-yellow">r refines the results for the query</mark>. If omitted, the filter defaults to <code>(objectClass=*)</code>.</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<pre><code class="language-plaintext">ldap://host:port/basedn?attribute?scope?filter</code></pre>
<ul>
  <li>LDAP search account is configured during the OAuth IdP configuration, and contains a <mark class="marker-yellow">Bind Distinguished Name (Bind DN)</mark> and a<mark class="marker-yellow"> Bind Password</mark>, and it is used to search for identities that the user provided during the login.</li>
</ul>
<blockquote>
  <p>In LDAP, the <strong>Bind Distinguished Name (Bind DN)</strong> and <strong>Bind Password</strong> are used to authenticate a client (like an application or user) to the LDAP server before performing operations like search, add, or modify.</p>
</blockquote>
<ul>
  <li>On a unique match from the search, the <mark class="marker-yellow">provided credentials are submitted to the LDAP server in a second interaction</mark>, and an <mark class="marker-yellow">authentication binding is created</mark> between an <mark class="marker-yellow">OpenShift user resource and the returned LDAP </mark><code><mark class="marker-yellow">id</mark></code><mark class="marker-yellow"> and </mark><code><mark class="marker-yellow">preferredUsername</mark></code><mark class="marker-yellow"> values.</mark></li>
  <li><mark class="marker-yellow">An administrator must synchronize groups from an LDAP server</mark> as an additional cluster-side configuration before a full LDAP IdP configuration is complete. It is <mark class="marker-yellow">necessary to create a cluster cron job to routinely query the LDAP server and to update the OpenShift groups</mark> to ensure consistency within the cluster to any organizational updates to the LDAP group entries.</li>
</ul>
